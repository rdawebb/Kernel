#!/usr/bin/env bash
# kernel: universal shell launcher for the Kernel Mail App

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-${(%):-%N}}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
VENV_PYTHON="$VENV_DIR/bin/python"
REQUIREMENTS="$SCRIPT_DIR/requirements.txt"


# Create a virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    echo "Creating virtual environment..."
    if command -v uv >/dev/null 2>&1; then
        uv venv "$VENV_DIR" || { echo "Failed to create virtual environment with uv"; exit 1; }
    else
        python3 -m venv "$VENV_DIR" || { echo "Failed to create virtual environment with python3 -m venv"; exit 1; }
    fi
    VENV_CREATED=1
fi

# Activate the virtual environment
if [ -f "$VENV_DIR/bin/activate" ]; then
    # shellcheck source=/dev/null
    . "$VENV_DIR/bin/activate"
fi

# List of required modules (import names)
REQUIRED_MODULES=(
    aioimaplib
    aiosqlite
    apscheduler
    cryptography
    email_validator
    fast_mail_parser
    keyring
    pandas
    prompt_toolkit
    pydantic
    pytest
    pytest_asyncio
    dotenv
    rich
    textual
)

# Function to check if all modules are importable
check_modules_installed() {
    "$VENV_PYTHON" -c "\
import sys\nmissing = []\nfor mod in [
    'aioimaplib',
    'aiosqlite',
    'apscheduler',
    'cryptography',
    'email_validator',
    'fast_mail_parser',
    'keyring',
    'pandas',
    'prompt_toolkit',
    'pydantic',
    'pytest',
    'pytest_asyncio',
    'dotenv',
    'rich',
    'textual',
]:\n    try:\n        __import__(mod)\n    except ImportError:\n        missing.append(mod)\nif missing:\n    print('Missing:', ', '.join(missing))\n    sys.exit(1)\n" 2>/dev/null
}

if [ "$VENV_CREATED" = "1" ] || ! check_modules_installed; then
    if [ -f "$REQUIREMENTS" ]; then
        echo "Popping corn..."
        # Check if venv was created by uv (look for 'uv =' in pyvenv.cfg)
        if grep -q '^uv =' "$VENV_DIR/pyvenv.cfg" 2>/dev/null && command -v uv >/dev/null 2>&1; then
            uv pip install -r "$REQUIREMENTS" || { echo "Failed to install required Python packages with uv"; exit 1; }
        elif "$VENV_DIR/bin/uv" --version >/dev/null 2>&1; then
            "$VENV_DIR/bin/uv" pip install -r "$REQUIREMENTS" || { echo "Failed to install required Python packages with uv"; exit 1; }
        elif "$VENV_PYTHON" -m pip --version >/dev/null 2>&1; then
            "$VENV_PYTHON" -m pip install --upgrade pip || { echo "Failed to upgrade pip"; exit 1; }
            "$VENV_PYTHON" -m pip install -r "$REQUIREMENTS" || { echo "Failed to install required Python packages with pip"; exit 1; }
        else
            echo "pip not found in the virtual environment. Attempting to bootstrap with ensurepip..."
            "$VENV_PYTHON" -m ensurepip --upgrade || { echo "Failed to bootstrap pip with ensurepip. Please install pip or uv manually."; exit 1; }
            "$VENV_PYTHON" -m pip install --upgrade pip || { echo "Failed to upgrade pip after bootstrapping."; exit 1; }
            "$VENV_PYTHON" -m pip install -r "$REQUIREMENTS" || { echo "Failed to install required Python packages with pip after bootstrapping."; exit 1; }
        fi
    else
        echo "Requirements file not found: $REQUIREMENTS"
        exit 1
    fi
fi

export PYTHONPATH="$SCRIPT_DIR/src:$PYTHONPATH"

# Run the Python script
exec "$VENV_PYTHON" -m src.cli.shell "$@"